# Week 1/12/25 Milestone: Similarity Calculation Algorithm

**Status:** ✅ Completed
**Date:** December 1, 2025
**Focus:** Implement similarity calculation algorithms for audio comparison

## Milestone Overview

This milestone implements the core similarity calculation functionality for the music plagiarism detection system. Two complementary algorithms were developed to compare audio features extracted in the previous milestone:

1. **Dynamic Time Warping (DTW)** - Handles temporal variations and different tempos
2. **Cosine Similarity** - Measures overall spectral similarity

## Implementation Details

### 1. Similarity Calculator Module (`similarity_calculator.py`)

A comprehensive module that implements multiple similarity metrics:

#### DTW (Dynamic Time Warping) Algorithm
- **Purpose:** Aligns and compares time-series data with temporal variations
- **Implementation:** Dynamic programming approach with Euclidean distance
- **Normalization:** Distances normalized by sequence length sum
- **Use Case:** Compares MFCC and Chroma sequences across time frames

```python
def dtw_distance(self, seq1: np.ndarray, seq2: np.ndarray) -> Tuple[float, np.ndarray]:
    """
    Calculate DTW distance between two sequences using dynamic programming
    Returns normalized distance and cost matrix
    """
```

#### Cosine Similarity
- **Purpose:** Measures similarity of overall spectral characteristics
- **Range:** 0 (completely different) to 1 (identical)
- **Implementation:** Uses SciPy's optimized cosine distance function
- **Use Case:** Compares feature statistics (mean, std) between tracks

```python
def cosine_similarity(self, vec1: np.ndarray, vec2: np.ndarray) -> float:
    """
    Calculate cosine similarity (1 - cosine_distance)
    Returns score from 0 to 1
    """
```

#### Feature Comparison

**MFCC Comparison** (Timbre/Texture):
- DTW on full MFCC sequences (13 coefficients × time frames)
- Cosine similarity on MFCC mean vectors
- Euclidean distance on MFCC statistics

**Chroma Comparison** (Harmony/Melody):
- DTW on full Chroma sequences (12 pitch classes × time frames)
- Cosine similarity on Chroma mean vectors
- Euclidean distance on Chroma statistics

#### Overall Similarity Score

Weighted combination of multiple metrics:

```
MFCC Score = (Cosine Similarity × 0.6) + ((1 - DTW Distance) × 0.4)
Chroma Score = (Cosine Similarity × 0.6) + ((1 - DTW Distance) × 0.4)
Overall Similarity = (MFCC Score × 0.6) + (Chroma Score × 0.4) × 100%
```

**Similarity Levels:**
- **Very High:** ≥80%
- **High:** 60-79%
- **Moderate:** 40-59%
- **Low:** 20-39%
- **Very Low:** <20%

### 2. API Endpoint (`/api/compare`)

New comparison endpoint in Flask application:

**Endpoint:** `POST /api/compare`

**Request Body:**
```json
{
    "file_id_1": "abc123",
    "file_id_2": "def456"
}
```

**Response:**
```json
{
    "file_id_1": "abc123",
    "file_id_2": "def456",
    "comparison": {
        "overall_similarity": 76.00,
        "similarity_level": "High",
        "mfcc_comparison": {
            "dtw_distance": 4.3589,
            "cosine_similarity": 1.0000,
            "euclidean_distance": 8.5256
        },
        "chroma_comparison": {
            "dtw_distance": 0.0001,
            "cosine_similarity": 1.0000,
            "euclidean_distance": 0.0000
        },
        "audio1_info": { ... },
        "audio2_info": { ... }
    },
    "message": "Comparison completed successfully"
}
```

### 3. Test Suite (`test_similarity.py`)

Comprehensive testing with synthetic audio:

**Test Audio Files Created:**
1. **440 Hz sine wave** - Pure A note
2. **440 Hz with modulation** - Similar to #1 with variation
3. **550 Hz sine wave** - C# note (different pitch)
4. **A major chord** - Multiple frequencies (440, 554, 659 Hz)

**Test Results:**

| Comparison | Expected | Result | Similarity |
|------------|----------|--------|------------|
| 440 Hz vs 440 Hz modulated | Similar | High | 76.00% |
| 440 Hz vs 550 Hz | Different | Low | 39.87% |
| 440 Hz vs A chord | Moderate | Moderate | 51.93% |
| 440 Hz modulated vs 550 Hz | Different | Low | 39.87% |
| 550 Hz vs A chord | Moderate | Moderate | 54.22% |

**Test Performance:**
- Feature extraction: ~0.025s per 3-second audio file
- Comparison calculation: Nearly instantaneous (<0.01s)

## Technical Achievements

### Algorithm Implementation
✅ Dynamic Time Warping with dynamic programming
✅ Cosine similarity for vector comparison
✅ Euclidean distance metrics
✅ Normalized scoring system

### API Integration
✅ RESTful comparison endpoint
✅ File ID-based feature lookup
✅ Comprehensive error handling
✅ Detailed comparison results

### Testing & Validation
✅ Synthetic audio generation
✅ Multiple similarity scenarios tested
✅ Automated test suite
✅ Results align with expectations

## Files Modified/Created

### New Files
- `backend/similarity_calculator.py` - Core similarity calculation module
- `backend/test_similarity.py` - Comprehensive test suite
- `WEEK_01_12_25.md` - This documentation

### Modified Files
- `backend/app.py` - Added `/api/compare` endpoint
  - Imported `SimilarityCalculator`
  - Implemented comparison logic
  - Updated health check message

## Usage Examples

### Using the API

**1. Upload two audio files:**
```bash
# Upload file 1
curl -X POST http://localhost:5000/api/upload \
  -F "file=@song1.mp3"
# Response: { "file_id": "abc123", ... }

# Upload file 2
curl -X POST http://localhost:5000/api/upload \
  -F "file=@song2.mp3"
# Response: { "file_id": "def456", ... }
```

**2. Compare the files:**
```bash
curl -X POST http://localhost:5000/api/compare \
  -H "Content-Type: application/json" \
  -d '{"file_id_1": "abc123", "file_id_2": "def456"}'
```

### Using the Module Directly

```python
from similarity_calculator import compare_features

# Compare two feature files
results = compare_features(
    'features/song1_features.json',
    'features/song2_features.json'
)

print(f"Similarity: {results['overall_similarity']:.2f}%")
print(f"Level: {results['similarity_level']}")
```

## Algorithm Analysis

### DTW Advantages
- **Tempo-invariant:** Handles speed differences
- **Alignment:** Finds optimal temporal matching
- **Robustness:** Works with different song lengths

### DTW Limitations
- **Computational cost:** O(n×m) complexity
- **Memory usage:** Requires full cost matrix
- **Normalization needed:** Raw distances not comparable

### Cosine Similarity Advantages
- **Fast computation:** Linear time complexity
- **Normalized:** Range [0,1] easy to interpret
- **Statistical:** Captures overall characteristics

### Cosine Similarity Limitations
- **Temporal information lost:** Only compares aggregated statistics
- **Length-independent:** Ignores duration differences
- **Magnitude-invariant:** Ignores intensity differences

### Why Both Algorithms?

The combination provides comprehensive comparison:
- **DTW** captures temporal and structural similarities
- **Cosine** captures overall spectral characteristics
- **Together** they detect both melodic and rhythmic similarities

## Performance Metrics

**Feature Extraction:** 0.025s per 3-second audio
**DTW Calculation:** <0.01s for typical sequences
**Cosine Similarity:** <0.001s for vectors
**Total Comparison:** <0.02s per file pair

**Scalability:** Can compare 50+ file pairs per second

## Next Steps (Week 8/12/25)

The next milestone will focus on **Comparison Visualization Interface**:
- Visual representation of similarity scores
- Highlight matching sections in waveforms
- Side-by-side comparison view
- Interactive result exploration
- Export comparison reports

## Running the Tests

```bash
cd backend
source venv/bin/activate
python test_similarity.py
```

Expected output shows similarity scores for various test pairs with detailed metrics.

## Dependencies

All dependencies already in `requirements.txt`:
- `scipy>=1.11.4` - For cosine distance calculation
- `numpy>=1.24.3` - For array operations
- `librosa>=0.10.1` - For feature loading
- `soundfile>=0.12.1` - For test audio creation

## Conclusion

Week 1/12/25 milestone successfully implements the core similarity calculation functionality. The system can now:

1. ✅ Compare audio files using DTW and Cosine similarity
2. ✅ Provide detailed metric breakdowns (MFCC + Chroma)
3. ✅ Calculate overall similarity scores (0-100%)
4. ✅ Classify similarity levels (Very Low to Very High)
5. ✅ Process comparisons in real-time (<0.02s)

The foundation is now in place for building the visualization interface in the next milestone.

---

**Milestone Duration:** Week of December 1, 2025
**Lines of Code Added:** ~450
**Test Coverage:** 5 comparison scenarios
**API Endpoints:** +1 (`/api/compare`)
